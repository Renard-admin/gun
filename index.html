<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cowboy Duel Arena</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"%3E%3Cpath fill="%23d4a373" fill-opacity="0.2" d="M0,96L48,101.3C96,107,192,117,288,138.7C384,160,480,192,576,181.3C672,171,768,117,864,101.3C960,85,1056,107,1152,138.7C1248,171,1344,213,1392,234.7L1440,256L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"%3E%3C/path%3E%3C/svg%3E');
            background-size: cover;
        }
        h1 {
            font-size: 3em;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #b5651d;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #mode-select {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #b5651d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #8b4513;
            transform: translateY(-2px);
        }
        #video-container {
            position: relative;
            width: 80vw;
            height: 60vh;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        #video {
            width: 100%;
            height: 100%;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            color: white;
            text-shadow: 2px 2px 4px black;
            display: none;
            z-index: 10;
        }
        #winner-display {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        #winner-img {
            width: 300px;
            height: auto;
            border: 5px solid #b5651d;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #play-again {
            display: none;
        }
        .retro-font {
            font-family: 'Courier New', monospace;
        }
        .gunfire {
            position: absolute;
            font-size: 3em;
            color: #ffcc00;
            animation: flash 0.3s ease-out;
            pointer-events: none;
            z-index: 20;
        }
        @keyframes flash {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.1/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
</head>
<body>
    <h1 class="retro-font">Cowboy Duel Arena</h1>
    <div id="mode-select">
        <button onclick="startGame('duel')">Режим: Дуэль (Один выстрел)</button>
        <button onclick="startGame('bestOfThree')">Режим: Лучший из 3</button>
        <button onclick="startGame('reload')">Режим: С перезарядкой</button>
    </div>
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="timer"></div>
    </div>
    <div id="winner-display">
        <img id="winner-img" src="" alt="Победитель">
        <p id="winner-text" class="retro-font"></p>
    </div>
    <button id="play-again" onclick="resetGame()">Играть ещё раз</button>

    <!-- Звуки -->
    <audio id="beep1" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
    <audio id="beep2" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
    <audio id="beep3" src="https://www.soundjay.com/buttons/beep-08b.mp3"></audio>
    <audio id="gunshot" src="https://www.soundjay.com/gun/sounds/gunshot-01.mp3"></audio>
    <audio id="reload" src="https://www.soundjay.com/mechanical/sounds/reload-01.mp3"></audio>
    <audio id="draw" src="https://www.soundjay.com/human/sounds/whoosh-01.mp3"></audio>
    <audio id="win" src="https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3"></audio>

    <script>
        // Элементы
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const timerElement = document.getElementById('timer');
        const winnerDisplay = document.getElementById('winner-display');
        const winnerImg = document.getElementById('winner-img');
        const winnerText = document.getElementById('winner-text');
        const playAgain = document.getElementById('play-again');
        const modeSelect = document.getElementById('mode-select');

        // Звуки
        const beep1 = document.getElementById('beep1');
        const beep2 = document.getElementById('beep2');
        const beep3 = document.getElementById('beep3');
        const gunshot = document.getElementById('gunshot');
        const reload = document.getElementById('reload');
        const draw = document.getElementById('draw');
        const win = document.getElementById('win');

        // Переменные игры
        let currentMode = '';
        let player1Score = 0;
        let player2Score = 0;
        let requiredWins = 1;
        let pose = null;
        let camera = null;
        let gameStarted = false;
        let countdownInterval = null;
        let goTime = 0;
        let player1State = 'waiting'; // waiting, drawn, reloaded
        let player2State = 'waiting';
        let lastFrameTime = 0;

        // Инициализация MediaPipe Pose
        pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`,
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        async function startGame(mode) {
            currentMode = mode;
            player1Score = 0;
            player2Score = 0;
            player1State = 'waiting';
            player2State = 'waiting';

            if (mode === 'bestOfThree') requiredWins = 2;
            else if (mode === 'reload') requiredWins = 1;
            else requiredWins = 1;

            modeSelect.style.display = 'none';
            winnerDisplay.style.display = 'none';
            playAgain.style.display = 'none';

            try {
                await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                camera.start();
                setTimeout(startCountdown, 1000);
            } catch (err) {
                alert("Не удалось получить доступ к камере. Проверьте разрешения.");
            }
        }

        function startCountdown() {
            gameStarted = true;
            let count = 3;
            timerElement.style.display = 'block';
            timerElement.textContent = count;

            // Воспроизведение звуков
            const beeps = [beep1, beep2, beep3];
            let beepIndex = 0;

            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    timerElement.textContent = count;
                    beeps[beepIndex].currentTime = 0;
                    beeps[beepIndex].play();
                    beepIndex++;
                } else {
                    timerElement.textContent = 'FIRE!';
                    beep3.currentTime = 0;
                    beep3.play();
                    clearInterval(countdownInterval);
                    goTime = Date.now();
                    setTimeout(() => {
                        timerElement.style.display = 'none';
                    }, 800);
                }
            }, 1000);
        }

        function onResults(results) {
            if (!gameStarted || !results.poseLandmarks) return;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // Рисуем скелет
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});
            canvasCtx.restore();

            // После "FIRE!"
            if (goTime > 0 && Date.now() - goTime > 800) {
                detectPlayers(results.poseLandmarks);
            }
        }

        function detectPlayers(landmarks) {
            const leftPlayer = [];
            const rightPlayer = [];

            landmarks.forEach(lm => {
                if (lm.visibility > 0.5) {
                    if (lm.x < 0.5) leftPlayer.push(lm);
                    else rightPlayer.push(lm);
                }
            });

            if (leftPlayer.length > 10) checkPlayerAction(leftPlayer, 1);
            if (rightPlayer.length > 10) checkPlayerAction(rightPlayer, 2);
        }

        function checkPlayerAction(playerLandmarks, playerNum) {
            const shoulder = playerLandmarks.find(lm => lm.name === 'right_shoulder') || 
                           playerLandmarks[12];
            const elbow = playerLandmarks.find(lm => lm.name === 'right_elbow') || 
                         playerLandmarks[14];
            const wrist = playerLandmarks.find(lm => lm.name === 'right_wrist') || 
                         playerLandmarks[16];

            if (!shoulder || !wrist) return;

            const angle = Math.atan2(wrist.y - shoulder.y, wrist.x - shoulder.x) * 180 / Math.PI;
            const isHorizontal = Math.abs(angle) < 25;

            if (currentMode === 'reload') {
                if (playerNum === 1 && player1State === 'waiting' && isHorizontal) {
                    player1State = 'drawn';
                    draw.currentTime = 0;
                    draw.play();
                    createGunfireEffect(shoulder.x * canvasElement.width, shoulder.y * canvasElement.height);
                    setTimeout(() => checkReload(playerNum), 500);
                }
                if (playerNum === 2 && player2State === 'waiting' && isHorizontal) {
                    player2State = 'drawn';
                    draw.currentTime = 0;
                    draw.play();
                    createGunfireEffect(shoulder.x * canvasElement.width, shoulder.y * canvasElement.height);
                    setTimeout(() => checkReload(playerNum), 500);
                }
            } else {
                if ((playerNum === 1 && player1State === 'waiting') || 
                    (playerNum === 2 && player2State === 'waiting')) {
                    if (isHorizontal) {
                        handleWin(playerNum);
                    }
                }
            }
        }

        function checkReload(playerNum) {
            // Простая проверка: рука опустилась и поднялась
            if ((playerNum === 1 && player1State === 'drawn') ||
                (playerNum === 2 && player2State === 'drawn')) {
                reload.currentTime = 0;
                reload.play();
                setTimeout(() => {
                    if (playerNum === 1) player1State = 'reloaded';
                    else player2State = 'reloaded';
                    gunshot.currentTime = 0;
                    gunshot.play();
                    handleWin(playerNum);
                }, 600);
            }
        }

        function createGunfireEffect(x, y) {
            const flash = document.createElement('div');
            flash.className = 'gunfire';
            flash.textContent = 'BANG!';
            flash.style.left = (x - 50) + 'px';
            flash.style.top = (y - 50) + 'px';
            document.getElementById('video-container').appendChild(flash);
            setTimeout(() => flash.remove(), 300);
        }

        function handleWin(player) {
            gameStarted = false;
            goTime = 0;

            if (player === 1) player1Score++;
            else player2Score++;

            gunshot.currentTime = 0;
            gunshot.play();

            captureWinner(player);

            setTimeout(() => {
                if (player1Score >= requiredWins || player2Score >= requiredWins) {
                    showFinalWinner(player1Score > player2Score ? 1 : 2);
                } else {
                    setTimeout(startCountdown, 1500);
                }
            }, 800);
        }

        function captureWinner(player) {
            const cropX = player === 1 ? 0 : canvasElement.width / 2;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvasElement.width / 2;
            tempCanvas.height = canvasElement.height;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(videoElement, cropX, 0, tempCanvas.width, tempCanvas.height, 0, 0, tempCanvas.width, tempCanvas.height);
            winnerImg.src = tempCanvas.toDataURL('image/png');
        }

        function showFinalWinner(player) {
            winnerText.textContent = `ПОБЕДИТЕЛЬ: ИГРОК ${player}!`;
            winnerDisplay.style.display = 'flex';
            playAgain.style.display = 'block';
            win.currentTime = 0;
            win.play();
        }

        function resetGame() {
            player1Score = 0;
            player2Score = 0;
            player1State = 'waiting';
            player2State = 'waiting';
            winnerDisplay.style.display = 'none';
            playAgain.style.display = 'none';
            modeSelect.style.display = 'flex';
            timerElement.style.display = 'none';
            gameStarted = false;
            goTime = 0;
            camera.stop();
        }

        // Авто-ресайз
        window.addEventListener('resize', () => {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
        });
    </script>
</body>
</html>